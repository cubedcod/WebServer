#!/bin/sh
# configure transparent proxy for DNS/HTTP/HTTPS egress
# run with iptable privileges, proxy uid is first arg: ./proxy_routes 1000

open_UDP () {
    iptables  -A INPUT  -p udp --sport $1 -j ACCEPT
    ip6tables -A INPUT  -p udp --sport $1 -j ACCEPT
    iptables  -A INPUT  -p udp --dport $1 -j ACCEPT
    ip6tables -A INPUT  -p udp --dport $1 -j ACCEPT
    iptables  -A OUTPUT -p udp --sport $1 -j ACCEPT
    ip6tables -A OUTPUT -p udp --sport $1 -j ACCEPT
    iptables  -A OUTPUT -p udp --dport $1 -j ACCEPT
    ip6tables -A OUTPUT -p udp --dport $1 -j ACCEPT
}

open_TCP () {
    iptables  -A INPUT  -p tcp --sport $1 -j ACCEPT
    ip6tables -A INPUT  -p tcp --sport $1 -j ACCEPT
    iptables  -A INPUT  -p tcp --dport $1 -j ACCEPT
    ip6tables -A INPUT  -p tcp --dport $1 -j ACCEPT
    iptables  -A OUTPUT -p tcp --sport $1 -j ACCEPT
    ip6tables -A OUTPUT -p tcp --sport $1 -j ACCEPT
    iptables  -A OUTPUT -p tcp --dport $1 -j ACCEPT
    ip6tables -A OUTPUT -p tcp --dport $1 -j ACCEPT
}
open_port () {
    open_UDP $1 $2
    open_TCP $1 $2
}

# policy
iptables  -A INPUT -p icmp -j ACCEPT
ip6tables -A INPUT -p icmp -j ACCEPT
iptables  -A INPUT -i lo   -j ACCEPT
ip6tables -A INPUT -i lo   -j ACCEPT
iptables  -A OUTPUT -p icmp -j ACCEPT
ip6tables -A OUTPUT -p icmp -j ACCEPT
iptables  -A OUTPUT -o lo   -j ACCEPT
ip6tables -A OUTPUT -o lo   -j ACCEPT
iptables  -P OUTPUT DROP
ip6tables -P OUTPUT DROP

# misc services
open_TCP     22 SSH
open_TCP     43 whois
open_port    67 DHCP
open_port    68 DHCP

## DNS
iptables  -A OUTPUT -p tcp --sport 53 -j ACCEPT -m owner --uid-owner $1 # traffic from proxy
ip6tables -A OUTPUT -p tcp --sport 53 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p tcp --dport 53 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p tcp --dport 53 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p udp --sport 53 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p udp --sport 53 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p udp --dport 53 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p udp --dport 53 -j ACCEPT -m owner --uid-owner $1
#iptables  -t nat -A OUTPUT -p tcp --dport  53 -j REDIRECT --to-ports 1053 -m owner ! --uid-owner $1 # traffic not from proxy
#ip6tables -t nat -A OUTPUT -p tcp --dport  53 -j REDIRECT --to-ports 1053 -m owner ! --uid-owner $1
#iptables  -t nat -A OUTPUT -p udp --dport  53 -j REDIRECT --to-ports 1053 -m owner ! --uid-owner $1
#ip6tables -t nat -A OUTPUT -p udp --dport  53 -j REDIRECT --to-ports 1053 -m owner ! --uid-owner $1

## HTTP
iptables  -A OUTPUT -p tcp --sport 80 -j ACCEPT -m owner --uid-owner $1 # traffic from proxy
ip6tables -A OUTPUT -p tcp --sport 80 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p tcp --dport 80 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p tcp --dport 80 -j ACCEPT -m owner --uid-owner $1
iptables  -t nat -A OUTPUT -p tcp --dport  80 -j REDIRECT --to-ports 8000 -m owner ! --uid-owner $1 # traffic not from proxy
ip6tables -t nat -A OUTPUT -p tcp --dport  80 -j REDIRECT --to-ports 8000 -m owner ! --uid-owner $1

## HTTPS
open_TCP   443 HTTPS
iptables  -A OUTPUT -p tcp --sport 443 -j ACCEPT -m owner --uid-owner $1 # traffic from proxy
ip6tables -A OUTPUT -p tcp --sport 443 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p tcp --dport 443 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p tcp --dport 443 -j ACCEPT -m owner --uid-owner $1
iptables  -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8443 -m owner ! --uid-owner $1 # traffic not from proxy
ip6tables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8443 -m owner ! --uid-owner $1

open_TCP    587 SMTP
open_port  1053 DNS
open_TCP   4860 WZBC
open_TCP   8000 HTTP
open_TCP   8022 SSH
open_TCP   8080 HTTP
open_port  8073 KiwiSDR
open_TCP   8443 HTTP
open_port  8901 WebSDR
open_TCP   9418 Git
open_UDP  60001 Mosh
open_UDP  60002 Mosh
open_UDP  60003 Mosh
