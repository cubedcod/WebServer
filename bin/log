#!/usr/bin/env ruby
require 'open3'
require_relative '../ruby/index'
tail = "tail #{ARGV.empty? ? '-f ~/web/log/access.log' : ARGV.join(' ')}"
Open3.popen3(tail) do |stdin, stdout, stderr, thread|
  hosts={}
  while line=stdout.gets do
    t=line.split ' '
    status,method,addr,action,mime=[t[3],t[5],t[6],t[8],t[9]]
    color=case status
          when /304/
            '30'
          when /ABORT|[45]0[0-9]|DENI/
            '31'
          when /200/
            if hosts[addr.R.host]
              '37'
            else
              hosts[addr.R.host] = true
              '32'
            end
          else
            '30'
          end
    puts "\e[7m" + method + "\e[0m \e[" + color + ";1m" + status + " \e[7m" + addr + "\e[0m " + "#{action} #{mime}"
  end
end
