#!/bin/sh
uid=$1

open_UDP () {
    echo opening UDP port $1 for $2
    iptables  -A INPUT  -p udp --sport $1 -j ACCEPT
    ip6tables -A INPUT  -p udp --sport $1 -j ACCEPT
    iptables  -A OUTPUT -p udp --dport $1 -j ACCEPT
    ip6tables -A OUTPUT -p udp --dport $1 -j ACCEPT
}
open_TCP () {
    echo opening TCP port $1 for $2
    iptables  -A INPUT  -p tcp --sport $1 -j ACCEPT
    ip6tables -A INPUT  -p tcp --sport $1 -j ACCEPT
    iptables  -A OUTPUT -p tcp --dport $1 -j ACCEPT
    ip6tables -A OUTPUT -p tcp --dport $1 -j ACCEPT
}
open_port () {
    open_UDP $1 $2
    open_TCP $1 $2
}

# policy defaults
iptables  -P INPUT DROP
ip6tables -P INPUT DROP
iptables  -P OUTPUT DROP
ip6tables -P OUTPUT DROP

# ICMP
iptables  -A INPUT -p icmp -j ACCEPT
ip6tables -A INPUT -p icmp -j ACCEPT
iptables  -A OUTPUT -p icmp -j ACCEPT
ip6tables -A OUTPUT -p icmp -j ACCEPT

# localnet
iptables  -A INPUT -i lo -j ACCEPT
ip6tables -A INPUT -i lo -j ACCEPT
iptables  -A OUTPUT -o lo -j ACCEPT
ip6tables -A OUTPUT -o lo -j ACCEPT

# open ports
open_port    22 SSH
open_port    43 whois
open_port    53 DNS
open_port    67 DHCP
open_port    68 DHCP
open_TCP     80 HTTP
open_TCP    443 HTTPS
open_port   587 SMTP
open_port  6789 IRC
open_port  8000 HTTP
open_port  8022 SSH
open_port  8073 SDR
open_port  8080 "HTTP forward"
open_port  8081 "HTTP transparent"
open_port  8082 "HTTPS transparent"
open_port  9418 Git
open_port 22000 Syncthing
open_port 60001 Mosh
open_port 60002 Mosh
open_port 60003 Mosh

# route HTTP. for transparent proxy run browser or client as different user
iptables  -A OUTPUT -p udp --dport 80 -j DROP
ip6tables -A OUTPUT -p udp --dport 80 -j DROP
iptables  -A OUTPUT -p udp --dport 443 -j DROP
ip6tables -A OUTPUT -p udp --dport 443 -j DROP
iptables  -t nat -A OUTPUT -p tcp --dport  80 -j REDIRECT --to-ports 8082 -m owner ! --uid-owner $uid
ip6tables -t nat -A OUTPUT -p tcp --dport  80 -j REDIRECT --to-ports 8082 -m owner ! --uid-owner $uid
iptables  -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8081 -m owner ! --uid-owner $uid
ip6tables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8081 -m owner ! --uid-owner $uid
