#!/bin/sh

# HTTP
iptables  -A OUTPUT -p tcp --sport 80 -j ACCEPT -m owner --uid-owner $1                             # traffic from proxy
ip6tables -A OUTPUT -p tcp --sport 80 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p tcp --dport 80 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p tcp --dport 80 -j ACCEPT -m owner --uid-owner $1

iptables  -t nat -A OUTPUT -p tcp --dport  80 -j REDIRECT --to-ports 8000 -m owner ! --uid-owner $1 # proxied traffic
ip6tables -t nat -A OUTPUT -p tcp --dport  80 -j REDIRECT --to-ports 8000 -m owner ! --uid-owner $1

# HTTPS
iptables  -A OUTPUT -p tcp --sport 443 -j ACCEPT -m owner --uid-owner $1                            # traffic from proxy
ip6tables -A OUTPUT -p tcp --sport 443 -j ACCEPT -m owner --uid-owner $1
iptables  -A OUTPUT -p tcp --dport 443 -j ACCEPT -m owner --uid-owner $1
ip6tables -A OUTPUT -p tcp --dport 443 -j ACCEPT -m owner --uid-owner $1

iptables  -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8443 -m owner ! --uid-owner $1 # proxied traffic
ip6tables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8443 -m owner ! --uid-owner $1
