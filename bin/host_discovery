#!/usr/bin/env ruby
# coding: utf-8
STDOUT.sync = true
require_relative '../index'
require 'file-tail'
hosts = {}
File::Tail::Logfile.tail('web.log') do |line|
  t = line.split /\s+/
  url = t[6]
  if url&.match? /^http/
    url = url.R
    method = t[5]
    estatus = t[3]
    status = estatus.split('/')[-1].to_i
    denied = estatus.match? /DENIED|NONE/
    fetched = !estatus.match?(/HIT/)
    format = url.format_icon t[9]
    unless hosts.has_key?(url.host) || denied || url.deny_domain?
      hosts[url.host] = true
      puts [(WebResource::HTTP.action_icon method, fetched),
            (WebResource::HTTP.status_icon status),
            format,
            "\e[#{denied ? '31;1' : WebResource::HTTP.format_color(format)}m",
            url,
            "\e[0m"].join ' '
    end
  end
end
